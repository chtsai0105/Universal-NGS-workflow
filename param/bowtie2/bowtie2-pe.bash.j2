#!/bin/bash
{% if use_slurm == True %}
#SBATCH --job-name={{ program }}
#SBATCH --ntasks={{ ntasks }}
#SBATCH --cpus-per-task={{ threads }}
#SBATCH --mem={{ mem }}
#SBATCH --array=1-{{ total_tasks }}%{{ ntasks }}
#SBATCH --output=sbatch_log/%x_%A_%a.out
{% endif %}

METADATA={{ metadata }}
INPUT_DIR={{ input_dir }}
OUTPUT_DIR={{ output_dir }}
INDEX={{ index }}

THREADS={{ threads }}

mkdir -p $OUTPUT_DIR

# Check index
if [ -z compgen -G $INDEX.*.bt2) ]
then
    echo "Error: Index not found. Please build the index first before alignment. Refer to script #_bowtie2-index.bash"
fi

# Run bowtie2
sed -n '{{ line_start }},$p' $METADATA | \
{% if use_slurm == True %}sed -n '$SLURM_ARRAY_TASK_ID{p;q;}' $METADATA | \{% endif %}
while IFS="," read Accession R1 R2 Strain Condition Replicate
do
	sample=`echo $Strain $Condition $Replicate | tr ' ' '_'`
	sorted_bam="$sample.sorted.bam"
	log="$sample.align.log"

	echo "Processing $sample ..."
	bowtie2	-p $THREADS \
			-x $INDEX -1 $INPUT_DIR/$R1 -2 $INPUT_DIR/$R2 2> $OUTPUT_DIR/$log | \
	sambamba view -f bam -S -t $THREADS /dev/stdin | \
	sambamba sort -m 6G -o $OUTPUT_DIR/$sorted_bam -t $THREADS /dev/stdin
done
